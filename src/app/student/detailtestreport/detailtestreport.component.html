<div>
    <h1 style="text-align: center; margin-top: 2em;">Test Result Analysis
    </h1>

    <mat-tab-group mat-align-tabs="center" (selectedTabChange)="tabChanged($event)">
        <mat-tab label="Tabular Report">
            <ng-container *ngTemplateOutlet="tabularReportTemplate"></ng-container>
        </mat-tab>
        
        <mat-tab label="Chart Report">
            <ng-container *ngTemplateOutlet="chartReportTemplate"></ng-container>
        </mat-tab>
    </mat-tab-group>


    <ng-template #tabularReportTemplate>
        <div class="row">
            <div class="col-sm-3" style="border-left: 1px solid #bfc3c2; border-right: 1px solid #bfc3c2; margin-top: 1.2em; margin-bottom: 1.2em;">
                <div style="margin-top: 3em; margin-bottom:  1.5em;">
                    <p style="font-size: 21px; font-weight: 500;">All Tests History</p>
                </div>

                <p-tree 
                [value]="allTests" 
                selectionMode="single" 
                [(selection)]="defaultSelectedTest" 
                (onNodeSelect)="nodeSelected($event)"
                [filter]="true"></p-tree>

                <!-- <div class="col-sm-12" style="font-size: 18px; font-weight: 300; margin-bottom: 1em;">
                    <b>Areas of Strength</b>
                    
                    <p style="margin-top: 1.2em;">Based on this test, these are your strengths</p>

                    <div class="row" style="display : inline; margin-top: 2em">
                        <ng-container  *ngFor="let subject of strongSubjectList['strongSubject']">
                            <div class="col-sm-6" style="display: flex; align-items: baseline; width: 161px; height: 49px; float: left; margin-bottom: 2em;">
                                <div class="circle_box" style="display: contents;">
                                    <div>
                                        <svg>
                                            <circle [matTooltip]="(100 - subject.successPercent).toString() + '%'" matTooltipPosition='right' cx="20" cy="20" r="20" />
                                            <circle [matTooltip]="subject.successPercent.toString() + '%'" matTooltipPosition='right' [attr.stroke-dashoffset]="subject.successValue" cx="20" cy="20" r="20" />
                                        </svg>
                                    </div>
                                </div>
                                <div style="margin-left: 1.3em;">{{subject.name}}</div>
                            </div>
                        </ng-container>
                        <ng-container  *ngFor="let topic of strongTopicList['strongTopic']">
                            <div class="col-sm-6" style="display: flex; align-items: baseline; width: 161px; height: 49px; float: left; margin-bottom: 2em;">
                                <div class="circle_box" style="display: contents;">
                                    <div>
                                        <svg>
                                            <circle [matTooltip]="(100 - topic.successPercent).toString() + '%'" matTooltipPosition='right' cx="20" cy="20" r="20" />
                                            <circle [matTooltip]="topic.successPercent.toString() + '%'" matTooltipPosition='right' [attr.stroke-dashoffset]="topic.successValue" cx="20" cy="20" r="20" />
                                        </svg>
                                    </div>
                                </div>
                                <div style="margin-left: 1.3em;">{{topic.name}}</div>
                            </div>
                        </ng-container>
                    </div>
                </div> 
                <mat-divider></mat-divider>

                <div class="col-sm-12" style="font-size: 18px; font-weight: 300; margin-top: 1em">
                    <b>Areas of Focus</b>
                    <p style="margin-top: 1.2em;">Based on this test, these are your weakness</p>

                    <div class="row" style=" display : inline; margin-top: 2em">
                        <ng-container  *ngFor="let subject of weakSubjectList['weakSubject']">
                            <div class="col-sm-6" style="display: flex; align-items: baseline; width: 161px; height: 49px; float: left; margin-bottom: 2em;">
                                <div class="circle_box" style="display: contents;">
                                    <div>
                                        <svg>
                                            <circle [matTooltip]="(100 - subject.successPercent).toString() + '%'" matTooltipPosition='right' cx="20" cy="20" r="20" />
                                            <circle [matTooltip]="subject.successPercent.toString() + '%'" matTooltipPosition='right' [attr.stroke-dashoffset]="subject.successValue" cx="20" cy="20" r="20" />
                                        </svg>
                                    </div>
                                </div>
                                <div style="margin-left: 1.3em;">{{subject.name}}</div>
                            </div>
                        </ng-container>

                        <ng-container  *ngFor="let topic of weakTopicList['weakTopic']">
                            <div class="col-sm-6" style="display: flex; align-items: baseline; width: 161px; height: 49px; float: left; margin-bottom: 2em;">
                                <div class="circle_box" style="display: contents;">
                                    <div>
                                        <svg>
                                            <circle [matTooltip]="(100 - topic.successPercent).toString() + '%'" matTooltipPosition='right' cx="20" cy="20" r="20" />
                                            <circle [matTooltip]="topic.successPercent.toString() + '%'" matTooltipPosition='right' [attr.stroke-dashoffset]="topic.successValue" cx="20" cy="20" r="20" />
                                        </svg>
                                    </div>
                                </div>
                                <div style="margin-left: 1.3em;">{{topic.name}}</div>
                            </div>
                        </ng-container>
                    </div>
                </div>
            -->
            </div>
            <div class="col-sm-9">
                <mat-expansion-panel style="margin-right: 1.2em; margin-top: 1.2em; margin-bottom: 1.2em;" class="mat-card mat-elevation-z8" 
                                    (opened)="expandTable = true"
                                    (closed)="expandTable = false"
                                    [expanded]="true">
                    <mat-expansion-panel-header>
                        <mat-panel-title>
                            <div class="col-md-12 text-center" >
                                <h1 style="margin: 1em; font-weight: 500;">Score Summary</h1>
                            </div>
                        </mat-panel-title>
                    </mat-expansion-panel-header>

                    <div class="float-container">
                        <div class="mat-card " style="border: 1px solid black;">
                            <div class ="row" style="margin: 1em;">
                                <div class ="col-md-4">
                                    <b>TestId:</b> {{testId}}
                                </div>
                                <div class ="col-md-4">
                                    <b>Test Name:</b> {{testToShowInTable.testName}}
                                </div>
                                <div class="col-md-4">
                                    <b>Total Score:</b> {{totalScore}}
                                </div>
                            </div>
                            <div class ="row" style="margin: 1em;">
                                <div class ="col-md-4">
                                    <b>Test Taken By:</b> {{testToShowInTable.testTakenBy}}
                                </div>
                                <div class ="col-md-4">
                                    <b>Date:</b> {{testTakenDate | date:'yyyy/MM/dd' }}
                                </div>
                            </div>
                            <div class="green">
                                <!-- <div style="float: right; margin-right: 2em; margin-bottom: 1em; margin-top: 1em;">
                                    <button mat-raised-button style="margin-left: 1em; margin-bottom: inherit;" (click)="exporter.exportTable('xlsx', {fileName:'test', sheet: 'sheet_name', Props: {Author: 'OnlineExam'}})">Excel</button>
                                    <button mat-raised-button style="margin-left: 1em; margin-bottom: inherit;" (click)="exporter.exportTable('csv')">Csv</button>
                                    <button mat-raised-button style="margin-left: 1em; margin-bottom: inherit;" (click)="exporter.exportTable('json')">Json</button>
                                    <button mat-raised-button style="margin-left: 1em; margin-bottom: inherit;" (click)="exporter.exportTable('txt')">Txt</button>
                                    <button mat-raised-button style="margin-left: 1em; margin-bottom: inherit;" [useExistingCss]="true" printTitle="Your Test Result" printSectionId="content" ngxPrint>Pdf</button> 
                                </div> -->
                                <div style="clear: both;">
                                </div>
                                <div class="table-contents" id="content" #content>

                                    <p-table 
                                            [columns]="displayedColumns" 
                                            [paginator]="true" 
                                            [rows]="5" 
                                            [showCurrentPageReport]="true" 
                                            responsiveLayout="scroll"
                                            currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries" 
                                            [rowsPerPageOptions]="[5,10,20]" 
                                            [value]="testToShowInTable.testQuestions"
                                            styleClass="p-datatable-striped">
                                        <ng-template pTemplate="header" let-columns>
                                            <tr>
                                                <th>No</th>
                                                <th [pSortableColumn]="col.field" *ngFor="let col of columns">
                                                    {{col.header}}
                                                    <p-sortIcon [field]="col.field"></p-sortIcon>
                                                </th>
                                            </tr>
                                        </ng-template>
                                        <ng-template pTemplate="body" let-row let-i= "rowIndex" let-columns="columns">
                                            <tr>
                                                <td>
                                                    <div pTooltip="Click to review question" matTooltipPosition='right' 
                                                        style="cursor: pointer;" (click)="viewIndividualQuestion(row, i)">
                                                        <a style="text-align: center; color: #0490f4;">{{i + 1}}</a>
                                                    </div>
                                                </td>
                                                <td *ngFor="let col of columns">
                                                    <div *ngIf="col.field == 'result'; else resultElseBlock">
                                                        <div> 
                                                            <mat-icon *ngIf ='row.correctAnswer === row.selectedOption' style="color: green;">done</mat-icon>
                                                            <mat-icon *ngIf ='row.selectedOption!== null && row.correctAnswer !== row.selectedOption' style="color: red;">close</mat-icon>
                                                            <mat-icon *ngIf ='row.selectedOption === null' style="color: green;">question_mark</mat-icon> 
                                                        </div>
                                                    </div>
                                                    <ng-template #resultElseBlock>
                                                        {{row[col.field]}}
                                                    </ng-template>
                                                        
                                                </td>
                                            </tr>
                                        </ng-template>
                                    </p-table>

                                    

                                    <!-- <mat-table [ngClass]="'styled-table'" matTableExporter [dataSource] = "dataSource"  #exporter="matTableExporter"> 
                                        <ng-container matColumnDef="no">
                                            <mat-header-cell [ngClass]="'table-header-class'" *matHeaderCellDef> No 
                                            </mat-header-cell>
                                            <mat-cell *matCellDef="let element; let i = index;"> 
                                                <span class="mobile-label">No:</span>
                                                <div matTooltip="Click to review question" matTooltipPosition='right' (click)="viewIndividualQuestion(element, i)" style="display: inline-block; vertical-align: middle;">
                                                    <a style="text-align: center; color: #0490f4;">{{this.paginator.pageIndex* this.paginator.pageSize + i + 1 }}</a> 
                                                </div>
                                            </mat-cell>
                                        </ng-container>

                                        <ng-container matColumnDef="timeSpent">
                                            <mat-header-cell [ngClass]="'table-header-class'" *matHeaderCellDef> Time Spent
                                            </mat-header-cell>
                                            <mat-cell *matCellDef="let element"> 
                                                <span class="mobile-label">Time Spent:</span>
                                                {{element.totalTimeSpent}} s 
                                            </mat-cell>
                                        </ng-container>

                                        <ng-container matColumnDef="timesViewed">
                                            <mat-header-cell [ngClass]="'table-header-class'" *matHeaderCellDef> Times Viewed
                                            </mat-header-cell>
                                            <mat-cell *matCellDef="let element"> 
                                                <span class="mobile-label">Times Viewed:</span>
                                                1 
                                            </mat-cell>
                                        </ng-container>
                            
                                        <ng-container matColumnDef="result">
                                            <mat-header-cell [ngClass]="['table-header-class','quest-width']" *matHeaderCellDef> Result
                                            </mat-header-cell>
                                            <mat-cell [ngClass]="'quest-width'" *matCellDef="let element">
                                                <span class="mobile-label">Result:</span>
                                                <div> 
                                                    <mat-icon *ngIf ='element.correctAnswer === element.selectedOption' style="color: green;">done</mat-icon>
                                                    <mat-icon *ngIf ='element.selectedOption!== null && element.correctAnswer !== element.selectedOption' style="color: red;">close</mat-icon>
                                                    <mat-icon *ngIf ='element.selectedOption === null' style="color: green;">question_mark</mat-icon> 
                                                </div>
                                            </mat-cell>
                                        </ng-container>

                                        <ng-container matColumnDef="subjectTags">
                                            <mat-header-cell [ngClass]="'table-header-class'" *matHeaderCellDef> Subject Area 
                                            </mat-header-cell>
                                            <mat-cell *matCellDef="let element"> 
                                                <span class="mobile-label"> Subject Area:</span>
                                                <button disabled class="btn" style="margin-right: 1em; background-color: green; color: white;" 
                                                *ngFor="let subjectTag of element.subjectTags">{{subjectTag}}</button>
                                            </mat-cell>
                                        </ng-container>

                                        <ng-container matColumnDef="topicTags">
                                            <mat-header-cell [ngClass]="'table-header-class'" *matHeaderCellDef> Topic Area 
                                            </mat-header-cell>
                                            <mat-cell *matCellDef="let element"> 
                                                <span class="mobile-label">Topic Area:</span>
                                                <div style="display: inline; float: left;">
                                                    <button disabled class="btn" style="margin: 0.2em; background-color: red; color: white; display: inline;" 
                                                        *ngFor="let topicTag of element.topicTags">{{topicTag}}
                                                    </button>
                                                </div>
                                            </mat-cell>
                                        </ng-container>
                                        <mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></mat-header-row>
                                        <mat-row *matRowDef="let element; columns: displayedColumns;">
                                        </mat-row> 
                                    </mat-table>
                                    <mat-paginator [ngClass]="'styled-paginator'" [pageSize]="5" [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons></mat-paginator> -->
                                </div>
                            </div>
                        </div>   
                    </div> 

                    <mat-divider></mat-divider>
                    <div>
                        <div style="margin-top: 3em; margin-bottom:  1.5em;">
                            <p style="font-size: 21px; font-weight: 500;">Now let's look at what to do next:</p>
                        </div>
                        <div class="row">
                            <div class="col-sm-6" style="font-size: 18px; font-weight: 300; margin-bottom: 1em; display: inline; float: left; border-right: 1px solid #bfc3c2;">
                                <b>Areas of Strength</b>
                                <!-- <div> -->
                                <p style="margin-top: 1.2em;">Based on this test, these are your strengths</p>

                                <div class="row" style="display : inline; margin-top: 2em">
                                    <ng-container  *ngFor="let subject of strongSubjectList['strongSubject']">
                                        <div class="col-sm-6" style="display: flex; align-items: baseline; width: 161px; height: 49px; float: left; margin-bottom: 2em;">
                                            <div class="circle_box" style="display: contents;">
                                                <div>
                                                    <svg>
                                                        <circle [matTooltip]="(100 - subject.successPercent).toString() + '%'" matTooltipPosition='right' cx="20" cy="20" r="20" />
                                                        <circle [matTooltip]="subject.successPercent.toString() + '%'" matTooltipPosition='right' [attr.stroke-dashoffset]="subject.successValue" cx="20" cy="20" r="20" />
                                                    </svg>
                                                    <!-- <span>90%</span> -->
                                                </div>
                                            </div>
                                            <div style="margin-left: 1.3em;">{{subject.name}}</div>
                                        </div>
                                    </ng-container>
                                    <ng-container  *ngFor="let topic of strongTopicList['strongTopic']">
                                        <div class="col-sm-6" style="display: flex; align-items: baseline; width: 161px; height: 49px; float: left; margin-bottom: 2em;">
                                            <div class="circle_box" style="display: contents;">
                                                <div>
                                                    <svg>
                                                        <circle [matTooltip]="(100 - topic.successPercent).toString() + '%'" matTooltipPosition='right' cx="20" cy="20" r="20" />
                                                        <circle [matTooltip]="topic.successPercent.toString() + '%'" matTooltipPosition='right' [attr.stroke-dashoffset]="topic.successValue" cx="20" cy="20" r="20" />
                                                    </svg>
                                                    <!-- <span>90%</span> -->
                                                </div>
                                            </div>
                                            <div style="margin-left: 1.3em;">{{topic.name}}</div>
                                        </div>
                                    </ng-container>
                                </div>

                            </div>

                            <div class="col-sm-6" style="font-size: 18px; font-weight: 300;">
                                <b>Areas of Focus</b>
                                <!-- <div> -->
                                <p style="margin-top: 1.2em;">Based on this test, these are your weakness</p>

                                <div class="row" style=" display : inline; margin-top: 2em">
                                    <ng-container  *ngFor="let subject of weakSubjectList['weakSubject']">
                                        <div class="col-sm-6" style="display: flex; align-items: baseline; width: 161px; height: 49px; float: left; margin-bottom: 2em;">
                                            <div class="circle_box" style="display: contents;">
                                                <div>
                                                    <svg>
                                                        <circle [matTooltip]="(100 - subject.successPercent).toString() + '%'" matTooltipPosition='right' cx="20" cy="20" r="20" />
                                                        <circle [matTooltip]="subject.successPercent.toString() + '%'" matTooltipPosition='right' [attr.stroke-dashoffset]="subject.successValue" cx="20" cy="20" r="20" />
                                                    </svg>
                                                    <!-- <span>90%</span> -->
                                                </div>
                                            </div>
                                            <div style="margin-left: 1.3em;">{{subject.name}}</div>
                                        </div>
                                    </ng-container>
            
                                    <ng-container  *ngFor="let topic of weakTopicList['weakTopic']">
                                        <div class="col-sm-6" style="display: flex; align-items: baseline; width: 161px; height: 49px; float: left; margin-bottom: 2em;">
                                            <div class="circle_box" style="display: contents;">
                                                <div>
                                                    <svg>
                                                        <circle [matTooltip]="(100 - topic.successPercent).toString() + '%'" matTooltipPosition='right' cx="20" cy="20" r="20" />
                                                        <circle [matTooltip]="topic.successPercent.toString() + '%'" matTooltipPosition='right' [attr.stroke-dashoffset]="topic.successValue" cx="20" cy="20" r="20" />
                                                    </svg>
                                                    <!-- <span>90%</span> -->
                                                </div>
                                            </div>
                                            <div style="margin-left: 1.3em;">{{topic.name}}</div>
                                        </div>
                                    </ng-container>
                                </div>
                            </div>
                        </div>
                    </div>
                        
                </mat-expansion-panel>
            </div>
        </div>
    </ng-template>

    <ng-template #chartReportTemplate>
        <mat-expansion-panel style="margin: 1.6em;" class="mat-card mat-elevation-z8" 
                            (opened)="expandCharts = true"
                            (closed)="expandCharts = false"
                            [expanded]="true">
            <mat-expansion-panel-header>
                <mat-panel-title>
                    <div class="col-md-12 text-center" >
                        <h1 style="margin: 1em;">Chart Based Analysis</h1>
                    </div>
                </mat-panel-title>
            </mat-expansion-panel-header>
            <div class="row">
                <div class="col-md-6 ">
                    <div  style="border: 1px solid black; margin-bottom: 0.7em;">
                        <div style="display: flex; flex-flow: row-reverse;">
                            <mat-icon id="fullScreen1" style="width: auto; cursor: pointer;">zoom_out_map
                            </mat-icon>
                            <a download="subjectWiseBarGraph.png" id="download1">
                                <mat-icon  style="width: auto; cursor: pointer;" >file_download
                                </mat-icon>
                            </a>
                        </div>
                        <div id="subjectwise_chart_div" class="chart" style="height:400px; margin-bottom: 1em; margin-top: 1em;" ></div>
                    </div>
                </div>
                <div class="col-md-6 ">
                    <div style="border: 1px solid black; margin-bottom: 0.7em;">
                        <div style="display: flex; flex-flow: row-reverse;">
                            <mat-icon id="fullScreen2" style="width: auto; cursor: pointer;">zoom_out_map
                            </mat-icon>
                            <a download="topicWiseBarGraph.png" id="download2">
                                <mat-icon style="width: auto; cursor: pointer;">file_download
                                </mat-icon>
                            </a>
                        </div>
                        <div id="topicwise_chart_div" class="chart" style="height:400px; margin-bottom: 1em; margin-top: 1em;"></div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 ">
                    <div style="border: 1px solid black; margin-bottom: 0.7em;">
                        <div style="display: flex; flex-flow: row-reverse; ">
                            <mat-icon id="fullScreen3" style="width: auto; cursor: pointer;">zoom_out_map
                            </mat-icon>
                            <a href="" download="subjectWiseTimeSpentPieChart.png" id="download3">
                                <mat-icon style="width: auto; cursor: pointer;">file_download
                                </mat-icon>
                            </a>
                        </div>
                        <div id="subjectTimeSpent_chart_div" class="chart" style="height: 400px; margin-bottom: 1em; margin-top: 1em;"></div>
                    </div>
                </div>
                <div class="col-md-6 ">
                    <div style="border: 1px solid black; margin-bottom: 0.7em;">
                        <div style="display: flex; flex-flow: row-reverse; ">
                            <mat-icon id="fullScreen4" style="width: auto; cursor: pointer;">zoom_out_map
                            </mat-icon>
                            <a href ="" download="topicWiseTimeSpentPieChart.png" id="download4">
                                <mat-icon style="width: auto; cursor: pointer;">file_download
                                </mat-icon>
                            </a>
                        </div>
                        <div id="topicTimeSpent_chart_div" class="chart" style="height: 400px; margin-bottom: 1em; margin-top: 1em;"></div>
                    </div>
                </div>
            </div>
        </mat-expansion-panel>
    </ng-template>
</div>
    